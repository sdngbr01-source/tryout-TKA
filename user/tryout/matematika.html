<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tryout Matematika - SDN Gambirono 01</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .soal-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .header-tryout {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-paket {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .timer-badge {
            background: rgba(0,0,0,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 600px;
            margin: 20px auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid #f0f0f0;
            padding: 5px;
            background: white;
            object-fit: contain;
            transition: opacity 0.3s;
        }
        
        .soal-teks {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .option-group {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .option-group:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .option-group.selected {
            border-color: #667eea;
            background: #e6ecff;
        }
        
        .option-label {
            font-weight: bold;
            margin-right: 10px;
            color: #667eea;
        }
        
        .soal-navigator {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .nav-btn-soal {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-btn-soal.answered {
            background: #4caf50;
            color: white;
        }
        
        .nav-btn-soal.not-answered {
            background: #f44336;
            color: white;
        }
        
        .nav-btn-soal.current {
            border: 3px solid #667eea;
            transform: scale(1.1);
        }
        
        .nav-btn-soal:hover {
            transform: scale(1.1);
        }
        
        .btn-navigation {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-prev {
            background: #6c757d;
            color: white;
        }
        
        .btn-next {
            background: #667eea;
            color: white;
        }
        
        .btn-submit {
            background: #4caf50;
            color: white;
        }
        
        .btn-navigation:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-navigation:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .peringatan-soal {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-konfirmasi {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .btn-modal-ya {
            background: #4caf50;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-modal-tidak {
            background: #f44336;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Pesan error gambar */
        .gambar-error {
            margin: 20px 0;
        }

        /* Loading animation */
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../../assets/images/school-logo.png" alt="Logo" style="width: 80px;">
                <h3>SDN Gambirono 01</h3>
                <p>Tryout Matematika</p>
            </div>
            
            <div class="user-info" style="text-align: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                <p id="displayName" style="font-weight: bold;"></p>
                <p id="displayKelas"></p>
                <p id="displayNomor" style="font-size: 12px;"></p>
            </div>
            
            <ul class="sidebar-menu">
                <li><a href="../dashboard.html">üè† Dashboard</a></li>
                <li><a href="matematika.html" class="active">üìê Matematika</a></li>
                <li><a href="bahasa-indonesia.html">üìö B. Indonesia</a></li>
                <li><a href="#" id="logoutBtn">üö™ Logout</a></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header Tryout -->
            <div class="header-tryout">
                <div>
                    <h2>üìê Tryout Matematika</h2>
                    <div class="info-paket" id="paketInfo">
                        Paket Soal: <span id="paketSoal">-</span>
                    </div>
                </div>
                <div>
                    <div class="timer-badge" id="timer">
                        ‚è∞ <span id="timerDisplay">00:00</span>
                    </div>
                </div>
            </div>
            
            <!-- Peringatan -->
            <div class="peringatan-soal" id="peringatanSoal">
                <span>‚ö†Ô∏è</span>
                <span>Jawaban akan otomatis tersimpan. Pastikan semua soal terjawab sebelum waktu habis.</span>
            </div>
            
            <!-- Progress -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px;">
                <div>
                    <strong>Soal Terjawab:</strong> <span id="soalTerjawab">0</span>/<span id="totalSoal">0</span>
                </div>
                <div>
                    <strong>Sisa Soal:</strong> <span id="sisaSoal">0</span>
                </div>
            </div>
            
            <!-- Container Soal -->
            <div class="soal-container" id="questionContainer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="questionNumber">Soal 1 dari <span id="totalSoalDisplay">0</span></h3>
                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 5px;" id="tipeSoalDisplay">Pilihan Ganda</span>
                </div>
                
                <div class="soal-teks" id="questionText">
                    Memuat soal...
                </div>
                
                <img class="question-image" id="questionImage" src="" alt="Gambar Soal" style="display: none;">
                
                <div id="optionsContainer" style="margin-top: 30px;">
                    <!-- Opsi jawaban akan diisi oleh JavaScript -->
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px;">
                <button class="btn-navigation btn-prev" id="prevBtn" disabled>
                    ‚¨ÖÔ∏è Sebelumnya
                </button>
                <button class="btn-navigation btn-next" id="nextBtn">
                    Selanjutnya ‚û°Ô∏è
                </button>
                <button class="btn-navigation btn-submit" id="submitBtn" onclick="tampilkanKonfirmasi()">
                    ‚úÖ Selesai
                </button>
            </div>
            
            <!-- Soal Navigator -->
            <div class="soal-navigator" id="soalNavigator"></div>
        </div>
    </div>
    
    <!-- Modal Konfirmasi (akan tampil saat submit) -->
    <div id="confirmModal" style="display: none;" class="modal-konfirmasi">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">üîî Konfirmasi</h3>
            <p id="modalMessage">Apakah Anda yakin ingin mengakhiri tryout?</p>
            <div class="modal-buttons">
                <button class="btn-modal-ya" onclick="submitTryout()">Ya, Selesai</button>
                <button class="btn-modal-tidak" onclick="tutupModal()">Batal</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="../../js/firebase-config.js"></script>
    <script>
        // Cek login user
        const userId = sessionStorage.getItem('userId');
        const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
        
        if (!userId) {
            window.location.href = '../login.html';
        }
        
        // Tampilkan data user
        document.getElementById('displayName').textContent = userData.namaLengkap || 'Siswa';
        document.getElementById('displayKelas').textContent = 'Kelas ' + (userData.kelas || '-');
        document.getElementById('displayNomor').textContent = 'No. ' + (userData.nomorPeserta || '-');
        
        // Variabel global
        let soalList = [];
        let jawabanUser = [];
        let currentIndex = 0;
        let timerInterval = null;
        let waktuTotal = 3600; // 60 menit default
        let paketSoal = '';
        let soalTerjawab = 0;

        // ==================== FUNGSI KONVERSI GOOGLE DRIVE ====================
        function convertGoogleDriveLink(url) {
            console.log('üîç Original URL:', url); // LOG 1: Lihat URL asli
            
            if (!url || url === '') return '';
            
            // Jika sudah dalam format yang benar
            if (url.includes('uc?export=view') || url.includes('thumbnail?')) {
                console.log('‚úÖ URL sudah dalam format yang benar'); // LOG 2
                return url;
            }
            
            // Deteksi link Google Drive
            if (url.includes('drive.google.com')) {
                console.log('üìÅ Mendeteksi link Google Drive'); // LOG 3
                let fileId = '';
                
                // Format: https://drive.google.com/file/d/FILE_ID/view
                const fileMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (fileMatch) {
                    fileId = fileMatch[1];
                    console.log('üìå File ID (format /d/):', fileId); // LOG 4
                }
                
                // Format: https://drive.google.com/open?id=FILE_ID
                const openMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (openMatch) {
                    fileId = openMatch[1];
                    console.log('üìå File ID (format open):', fileId); // LOG 5
                }
                
                // Format: https://drive.google.com/uc?id=FILE_ID
                const ucMatch = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (ucMatch) {
                    fileId = ucMatch[1];
                    console.log('üìå File ID (format uc):', fileId); // LOG 6
                }
                
                if (fileId) {
                    const convertedUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
                    console.log('üîÑ Hasil konversi:', convertedUrl); // LOG 7
                    return convertedUrl;
                } else {
                    console.log('‚ùå Gagal mengekstrak File ID'); // LOG 8
                }
            }
            
            console.log('‚ÑπÔ∏è Bukan link Google Drive, menggunakan URL asli'); // LOG 9
            return url;
        }

        // Fungsi untuk mencoba ulang memuat gambar
        function cobaUlangGambar(url) {
            const imgElement = document.getElementById('questionImage');
            const errorDiv = document.querySelector('.gambar-error');
            
            if (errorDiv) {
                errorDiv.remove();
            }
            
            const imageUrl = convertGoogleDriveLink(url) + '&t=' + new Date().getTime();
            imgElement.src = imageUrl;
            imgElement.style.display = 'block';
            imgElement.style.opacity = '0.5';
        }

        // Load soal saat halaman dimuat
        window.addEventListener('load', function() {
            console.log('üìö Memuat soal Matematika...');
            loadSoal();
        });
        
        // Fungsi load soal
        async function loadSoal() {
            try {
                // Tampilkan loading
                document.getElementById('questionText').innerHTML = '‚è≥ Memuat soal...';
                
                // Ambil setting tryout
                const settingDoc = await db.collection('pengaturan').doc('tryout').get();
                let setting = { jumlahSoal: 20, waktu: 60 };
                
                if (settingDoc.exists) {
                    setting = settingDoc.data();
                }
                
                waktuTotal = (setting.waktu || 60) * 60; // Konversi ke detik
                
                // Ambil soal matematika yang aktif
                const soalSnapshot = await db.collection('soal')
                    .where('mapel', '==', 'Matematika')
                    .where('aktif', '==', true)
                    .get();
                
                console.log('üìä Jumlah soal ditemukan:', soalSnapshot.size);
                
                if (soalSnapshot.empty) {
                    document.getElementById('questionText').innerHTML = '‚ùå Belum ada soal Matematika tersedia. Silakan hubungi admin.';
                    document.getElementById('prevBtn').disabled = true;
                    document.getElementById('nextBtn').disabled = true;
                    document.getElementById('submitBtn').disabled = true;
                    return;
                }
                
                // Kumpulkan semua soal
                let semuaSoal = [];
                soalSnapshot.forEach(doc => {
                    semuaSoal.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Acak soal menjadi 3 paket (A, B, C)
                const paket = ['A', 'B', 'C'];
                paketSoal = paket[Math.floor(Math.random() * paket.length)];
                document.getElementById('paketSoal').textContent = paketSoal;
                
                // Acak urutan soal dan ambil sesuai jumlah yang diatur
                soalList = shuffleArray(semuaSoal).slice(0, setting.jumlahSoal);
                
                // Inisialisasi jawaban user
                jawabanUser = new Array(soalList.length).fill(null);
                
                // Update tampilan
                document.getElementById('totalSoal').textContent = soalList.length;
                document.getElementById('totalSoalDisplay').textContent = soalList.length;
                updateSoalTerjawab();
                updateSoalNavigator();
                
                // Tampilkan soal pertama
                tampilkanSoal(0);
                
                // Mulai timer
                mulaiTimer();
                
                console.log('‚úÖ Soal berhasil dimuat:', soalList.length);
                
            } catch (error) {
                console.error('‚ùå Error loading soal:', error);
                document.getElementById('questionText').innerHTML = '‚ùå Gagal memuat soal: ' + error.message;
            }
        }
        
        // Fungsi mengacak array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Fungsi menampilkan soal
        function tampilkanSoal(index) {
            if (index < 0 || index >= soalList.length) return;
            
            currentIndex = index;
            const soal = soalList[index];
            
            // Update nomor soal
            document.getElementById('questionNumber').innerHTML = `Soal ${index + 1} dari ${soalList.length}`;
            
            // Tampilkan tipe soal
            const tipeText = {
                'pg': 'Pilihan Ganda',
                'multiple': 'Multiple Choice',
                'bf': 'Benar/Salah (3 Pernyataan)'
            }[soal.tipe] || soal.tipe;
            document.getElementById('tipeSoalDisplay').textContent = tipeText;
            
            // Tampilkan teks soal
            document.getElementById('questionText').innerHTML = soal.soal || 'Soal tidak tersedia';
            
            // Tampilkan gambar jika ada - DENGAN KONVERSI GOOGLE DRIVE
            const imgElement = document.getElementById('questionImage');
            const gambar = soal.tautanimg || soal.tautan || '';

            // Hapus gambar error sebelumnya jika ada
            const existingError = document.querySelector('.gambar-error');
            if (existingError) {
                existingError.remove();
            }

            if (gambar) {
                // Konversi link Google Drive
                const imageUrl = convertGoogleDriveLink(gambar);
                console.log('üì∏ Memuat gambar:', imageUrl); // Untuk debugging
                
                imgElement.src = imageUrl;
                imgElement.style.display = 'block';
                
                // Tambahkan loading indicator
                imgElement.style.opacity = '0.5';
                
                // Error handling jika gambar gagal dimuat
                imgElement.onload = function() {
                    this.style.opacity = '1';
                    console.log('‚úÖ Gambar berhasil dimuat');
                };
                
                imgElement.onerror = function() {
                    console.log('‚ùå Gambar gagal dimuat:', gambar);
                    this.style.display = 'none';
                    
                    // Tampilkan pesan error yang lebih informatif
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'gambar-error';
                    errorDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px; margin: 20px 0;">
                            <span style="font-size: 24px;">üì∑</span>
                            <p style="margin-top: 10px; color: #856404;">
                                <strong>Gambar tidak dapat ditampilkan</strong><br>
                                <small style="font-size: 12px;">Link: ${gambar.substring(0, 50)}...</small>
                            </p>
                            <button onclick="cobaUlangGambar('${gambar}')" style="margin-top: 10px; padding: 5px 15px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üîÑ Coba Lagi
                            </button>
                        </div>
                    `;
                    
                    // Sisipkan setelah elemen gambar
                    this.parentNode.insertBefore(errorDiv, this.nextSibling);
                };
            } else {
                console.log('‚ÑπÔ∏è Tidak ada gambar untuk soal ini');
                imgElement.style.display = 'none';
            }
            
            // Buat opsi jawaban berdasarkan tipe soal
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            if (soal.tipe === 'pg') {
                // Pilihan Ganda
                const pilihan = ['A', 'B', 'C', 'D'];
                pilihan.forEach(huruf => {
                    if (soal[huruf]) {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = `option-group ${jawabanUser[index] === huruf ? 'selected' : ''}`;
                        optionDiv.onclick = () => pilihJawaban(index, huruf);
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'jawaban';
                        radio.value = huruf;
                        radio.checked = (jawabanUser[index] === huruf);
                        radio.style.display = 'none';
                        
                        const label = document.createElement('span');
                        label.innerHTML = `<span class="option-label">${huruf}.</span> ${soal[huruf]}`;
                        
                        optionDiv.appendChild(radio);
                        optionDiv.appendChild(label);
                        optionsContainer.appendChild(optionDiv);
                    }
                });
            } 
            else if (soal.tipe === 'multiple') {
                // Multiple Choice (bisa pilih lebih dari satu)
                const pilihan = ['A', 'B', 'C', 'D'];
                
                // Konversi jawaban tersimpan ke array
                const jawabanArray = jawabanUser[index] ? jawabanUser[index].split('') : [];
                
                pilihan.forEach(huruf => {
                    if (soal[huruf]) {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = `option-group ${jawabanArray.includes(huruf) ? 'selected' : ''}`;
                        optionDiv.onclick = () => pilihJawabanMultiple(index, huruf);
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = huruf;
                        checkbox.checked = jawabanArray.includes(huruf);
                        checkbox.style.display = 'none';
                        
                        const label = document.createElement('span');
                        label.innerHTML = `<span class="option-label">${huruf}.</span> ${soal[huruf]}`;
                        
                        optionDiv.appendChild(checkbox);
                        optionDiv.appendChild(label);
                        optionsContainer.appendChild(optionDiv);
                    }
                });
            } 
            else if (soal.tipe === 'bf') {
                // Benar Salah (3 pernyataan)
                for (let i = 1; i <= 3; i++) {
                    if (soal[`pernyataan${i}`]) {
                        const pernyataanDiv = document.createElement('div');
                        pernyataanDiv.style.marginBottom = '20px';
                        pernyataanDiv.style.padding = '15px';
                        pernyataanDiv.style.background = '#f8f9fa';
                        pernyataanDiv.style.borderRadius = '8px';
                        
                        const pernyataanText = document.createElement('div');
                        pernyataanText.innerHTML = `<strong>Pernyataan ${i}:</strong> ${soal[`pernyataan${i}`]}`;
                        pernyataanText.style.marginBottom = '10px';
                        
                        const optionContainer = document.createElement('div');
                        optionContainer.style.display = 'flex';
                        optionContainer.style.gap = '20px';
                        
                        // Opsi Benar
                        const benarDiv = document.createElement('div');
                        benarDiv.className = `option-group ${jawabanUser[index] && jawabanUser[index][`pernyataan${i}`] === 'B' ? 'selected' : ''}`;
                        benarDiv.style.flex = '1';
                        benarDiv.style.margin = '0';
                        benarDiv.onclick = () => pilihJawabanBF(index, i, 'B');
                        benarDiv.innerHTML = '‚úÖ Benar';
                        
                        // Opsi Salah
                        const salahDiv = document.createElement('div');
                        salahDiv.className = `option-group ${jawabanUser[index] && jawabanUser[index][`pernyataan${i}`] === 'S' ? 'selected' : ''}`;
                        salahDiv.style.flex = '1';
                        salahDiv.style.margin = '0';
                        salahDiv.onclick = () => pilihJawabanBF(index, i, 'S');
                        salahDiv.innerHTML = '‚ùå Salah';
                        
                        optionContainer.appendChild(benarDiv);
                        optionContainer.appendChild(salahDiv);
                        
                        pernyataanDiv.appendChild(pernyataanText);
                        pernyataanDiv.appendChild(optionContainer);
                        optionsContainer.appendChild(pernyataanDiv);
                    }
                }
            }
            
            // Update status navigasi
            document.getElementById('prevBtn').disabled = (index === 0);
            document.getElementById('nextBtn').disabled = (index === soalList.length - 1);
            
            // Update navigator
            updateSoalNavigator();
        }
        
        // Fungsi pilih jawaban untuk PG
        function pilihJawaban(index, jawaban) {
            jawabanUser[index] = jawaban;
            
            // Update tampilan opsi
            const options = document.querySelectorAll('.option-group');
            options.forEach(opt => {
                if (opt.querySelector('input[type="radio"]')?.value === jawaban) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            updateSoalTerjawab();
            updateSoalNavigator();
        }
        
        // Fungsi pilih jawaban untuk Multiple
        function pilihJawabanMultiple(index, huruf) {
            let jawaban = jawabanUser[index] || '';
            const jawabanArray = jawaban.split('');
            
            if (jawabanArray.includes(huruf)) {
                // Hapus jika sudah ada
                const newArray = jawabanArray.filter(h => h !== huruf);
                jawabanUser[index] = newArray.join('');
            } else {
                // Tambah jika belum ada
                jawabanArray.push(huruf);
                jawabanUser[index] = jawabanArray.sort().join('');
            }
            
            // Update tampilan
            tampilkanSoal(index); // Refresh tampilan
            updateSoalTerjawab();
            updateSoalNavigator();
        }
        
        // Fungsi pilih jawaban untuk BF
        function pilihJawabanBF(index, pernyataan, nilai) {
            if (!jawabanUser[index]) {
                jawabanUser[index] = {};
            }
            jawabanUser[index][`pernyataan${pernyataan}`] = nilai;
            
            // Update tampilan
            tampilkanSoal(index); // Refresh tampilan
            updateSoalTerjawab();
            updateSoalNavigator();
        }
        
        // Fungsi update jumlah soal terjawab
        function updateSoalTerjawab() {
            soalTerjawab = jawabanUser.filter(j => j !== null && j !== '').length;
            document.getElementById('soalTerjawab').textContent = soalTerjawab;
            document.getElementById('sisaSoal').textContent = soalList.length - soalTerjawab;
        }
        
        // Fungsi update navigator soal
        function updateSoalNavigator() {
            const navigator = document.getElementById('soalNavigator');
            navigator.innerHTML = '';
            
            for (let i = 0; i < soalList.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'nav-btn-soal';
                btn.textContent = i + 1;
                
                // Tentukan status jawaban
                if (jawabanUser[i] && jawabanUser[i] !== '' && 
                    (typeof jawabanUser[i] !== 'object' || Object.keys(jawabanUser[i]).length > 0)) {
                    btn.classList.add('answered');
                } else {
                    btn.classList.add('not-answered');
                }
                
                // Tandai soal yang sedang aktif
                if (i === currentIndex) {
                    btn.classList.add('current');
                }
                
                btn.onclick = () => tampilkanSoal(i);
                navigator.appendChild(btn);
            }
        }
        
        // Fungsi mulai timer
        function mulaiTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            let waktuTersisa = waktuTotal;
            
            timerInterval = setInterval(() => {
                waktuTersisa--;
                
                const menit = Math.floor(waktuTersisa / 60);
                const detik = waktuTersisa % 60;
                timerDisplay.textContent = `${menit.toString().padStart(2, '0')}:${detik.toString().padStart(2, '0')}`;
                
                // Peringatan jika waktu tinggal 5 menit
                if (waktuTersisa === 300) {
                    alert('‚ö†Ô∏è Waktu tersisa 5 menit!');
                }
                
                // Otomatis submit jika waktu habis
                if (waktuTersisa <= 0) {
                    clearInterval(timerInterval);
                    alert('‚è∞ Waktu habis! Tryout akan disubmit otomatis.');
                    submitTryout();
                }
            }, 1000);
        }
        
        // Fungsi tampilkan modal konfirmasi
        function tampilkanKonfirmasi() {
            const soalBelumTerjawab = soalList.length - soalTerjawab;
            const modal = document.getElementById('confirmModal');
            const modalMessage = document.getElementById('modalMessage');
            
            if (soalBelumTerjawab > 0) {
                modalMessage.innerHTML = `‚ö†Ô∏è Anda masih memiliki ${soalBelumTerjawab} soal belum terjawab.<br>Apakah tetap ingin mengakhiri tryout?`;
            } else {
                modalMessage.innerHTML = '‚úÖ Semua soal sudah terjawab! Apakah Anda yakin ingin mengakhiri tryout?';
            }
            
            modal.style.display = 'flex';
        }
        
        // Fungsi tutup modal
        function tutupModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        // Fungsi submit tryout
        async function submitTryout() {
            tutupModal();
            clearInterval(timerInterval);
            
            // Hitung nilai
            let benar = 0;
            for (let i = 0; i < soalList.length; i++) {
                const soal = soalList[i];
                const jawaban = jawabanUser[i];
                
                if (jawaban) {
                    if (soal.tipe === 'pg' && jawaban === soal.jawaban) {
                        benar++;
                    } else if (soal.tipe === 'multiple' && jawaban === soal.jawaban) {
                        benar++;
                    } else if (soal.tipe === 'bf') {
                        let benarSemua = true;
                        for (let j = 1; j <= 3; j++) {
                            if (jawaban[`pernyataan${j}`] !== soal[`jwb${j}`]) {
                                benarSemua = false;
                                break;
                            }
                        }
                        if (benarSemua) benar++;
                    }
                }
            }
            
            const nilaiPerSoal = 100 / soalList.length;
            const totalNilai = Math.round(benar * nilaiPerSoal * 100) / 100;
            
            // Tampilkan loading
            document.getElementById('questionContainer').innerHTML = '<div style="text-align: center; padding: 50px;"><h3>‚è≥ Menyimpan hasil...</h3></div>';
            
            try {
                // Simpan ke Firestore
                await db.collection('nilai').add({
                    userId: userId,
                    namaSiswa: userData.namaLengkap,
                    nomorPeserta: userData.nomorPeserta,
                    kelas: userData.kelas,
                    mapel: 'Matematika',
                    paket: paketSoal,
                    nilai: totalNilai,
                    benar: benar,
                    totalSoal: soalList.length,
                    waktu: firebase.firestore.FieldValue.serverTimestamp(),
                    jawaban: jawabanUser,
                    waktuPengerjaan: waktuTotal - parseInt(document.getElementById('timerDisplay').textContent.split(':')[0]) * 60 - parseInt(document.getElementById('timerDisplay').textContent.split(':')[1])
                });
                
                // Tampilkan hasil
                document.getElementById('questionContainer').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <h2 style="color: #4caf50; margin-bottom: 20px;">‚úÖ Tryout Selesai!</h2>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin: 20px 0;">
                            <h1 style="font-size: 48px;">${totalNilai}</h1>
                            <p style="font-size: 18px;">Nilai Anda</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0;">
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
                                <strong>Benar:</strong> ${benar}
                            </div>
                            <div style="background: #ffebee; padding: 20px; border-radius: 10px;">
                                <strong>Salah:</strong> ${soalList.length - benar}
                            </div>
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 10px;">
                                <strong>Total Soal:</strong> ${soalList.length}
                            </div>
                            <div style="background: #fff3e0; padding: 20px; border-radius: 10px;">
                                <strong>Paket Soal:</strong> ${paketSoal}
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            <a href="../dashboard.html" style="display: inline-block; background: #667eea; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin-right: 10px;">üè† Ke Dashboard</a>
                            <button onclick="window.location.reload()" style="background: #4caf50; color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer;">üîÑ Coba Lagi</button>
                        </div>
                    </div>
                `;
                
          
                
            } catch (error) {
                console.error('Error saving score:', error);
                alert('Gagal menyimpan nilai: ' + error.message);
            }
        }
        
        // Event listeners untuk navigasi
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentIndex > 0) {
                tampilkanSoal(currentIndex - 1);
            }
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentIndex < soalList.length - 1) {
                tampilkanSoal(currentIndex + 1);
            }
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            sessionStorage.clear();
            window.location.href = '../login.html';
        });
        
        // Cegah refresh dengan tombol F5 atau refresh browser
        window.addEventListener('beforeunload', function (e) {
            if (soalList.length > 0 && soalTerjawab < soalList.length) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>

